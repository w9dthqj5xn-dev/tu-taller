// ====================================================================
// REGLAS DE FIRESTORE COMPLETAS PARA TU TALLER
// ====================================================================
// 
// INSTRUCCIONES PARA APLICAR:
// 1. Ve a: https://console.firebase.google.com/
// 2. Selecciona tu proyecto "licencias-taller"
// 3. Ve a: Firestore Database ‚Üí Reglas (pesta√±a "Rules")
// 4. BORRA TODO el contenido actual
// 5. PEGA este c√≥digo completo
// 6. Haz clic en "Publicar" (Publish)
// 7. Espera el mensaje de confirmaci√≥n
//
// ====================================================================

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // LICENCIAS - Sistema de licencias
    // ============================================
    match /licencias/{license} {
      allow read: if true;  // Lectura p√∫blica para validaci√≥n
      allow write: if true;  // Permitir escritura para admin desde licencias.html
    }
    
    // ============================================
    // USUARIOS - Registro inicial y autenticaci√≥n
    // ============================================
    match /usuarios/{user} {
      allow read, write: if true;  // Acceso p√∫blico para sistema de usuarios normal
    }
    
    // ============================================
    // USUARIOS GOOGLE - Autenticaci√≥n con Google
    // ============================================
    match /usuarios-google/{userId} {
      // Permitir lectura y escritura a cualquier usuario autenticado
      // Esto permite el flujo completo de autenticaci√≥n y actualizaci√≥n de datos
      allow read, write: if request.auth != null;
    }
    
    // ============================================
    // CONFIGURACIONES - Logo, nombre taller, pol√≠ticas
    // ============================================
    match /configuraciones/{userId} {
      // Permitir que cada usuario autenticado acceda a su propia configuraci√≥n
      allow read, write: if request.auth != null;
      // Esto sincroniza la configuraci√≥n entre todos los dispositivos del usuario
    }
    
    // ============================================
    // USUARIOS-DATA - Datos de cada usuario
    // ============================================
    // Permite el funcionamiento completo de TODAS las funcionalidades:
    // ‚úÖ Clientes, √ìrdenes, Inventario, Pagos, Reportes, B√∫squedas
    match /usuarios-data/{userId} {
      // Permitir acceso a cualquiera (tanto usuarios normales como Google)
      allow read, write: if true;
      
      // ====== CLIENTES ======
      // Gesti√≥n completa de clientes
      match /clientes/{clienteId} {
        allow read, write, delete: if true;
      }
      
      // ====== √ìRDENES ======
      // Gesti√≥n de √≥rdenes de reparaci√≥n/servicio
      match /ordenes/{ordenId} {
        allow read, write, delete: if true;
      }
      
      // ====== INVENTARIO/REPUESTOS ======
      // Control de inventario y repuestos
      match /repuestos/{repuestoId} {
        allow read, write, delete: if true;
      }
      
      // ====== FACTURAS ======
      // Historial de facturas generadas
      match /facturas/{facturaId} {
        allow read, write, delete: if true;
      }
      
      // ====== PAGOS ======
      // Registro de pagos realizados
      match /pagos/{pagoId} {
        allow read, write, delete: if true;
      }
      
      // ====== PRODUCTOS ======
      // Cat√°logo de productos/servicios
      match /productos/{productoId} {
        allow read, write, delete: if true;
      }
      
      // ====== CONFIGURACI√ìN LOCAL DEL USUARIO ======
      // Preferencias y configuraci√≥n espec√≠fica del usuario
      match /configuracion/{configId} {
        allow read, write, delete: if true;
      }
      
      // ====== REGLA CATCH-ALL ======
      // Para cualquier otra subcolecci√≥n futura
      match /{collection}/{document=**} {
        allow read, write, delete: if true;
      }
    }
  }
}

// ====================================================================
// EXPLICACI√ìN COMPLETA DE LAS REGLAS
// ====================================================================
//
// 1. LICENCIAS
//    Prop√≥sito: Validar si un usuario tiene licencia activa
//    Acceso: P√∫blico (cualquiera puede validar y escribir)
//
// 2. USUARIOS
//    Prop√≥sito: Registro inicial con usuario/contrase√±a
//    Acceso: P√∫blico (permite crear cuentas nuevas)
//
// 3. USUARIOS-GOOGLE
//    Prop√≥sito: Datos de usuarios autenticados con Google
//    Acceso: Solo usuarios autenticados pueden leer/escribir
//    Seguridad: request.auth != null
//
// 4. CONFIGURACIONES (üÜï NUEVO)
//    Prop√≥sito: Logo, nombre del taller, direcci√≥n, pol√≠ticas
//    Acceso: Solo usuarios autenticados
//    Sincronizaci√≥n: Los datos se sincronizan autom√°ticamente
//                   entre todos los dispositivos del mismo usuario
//    Estructura: configuraciones/{userId}
//                - nombreTaller
//                - direccionTaller
//                - telefonoTaller
//                - emailTaller
//                - politicasTaller
//                - logoUrl (base64)
//                - fechaActualizacion
//
// 5. USUARIOS-DATA
//    Prop√≥sito: TODOS los datos operativos del usuario
//    Acceso: P√∫blico (permite usuarios normales sin request.auth)
//    
//    Estructura: usuarios-data/{email}/
//                ‚îú‚îÄ‚îÄ clientes/      - Gesti√≥n de clientes
//                ‚îú‚îÄ‚îÄ ordenes/       - √ìrdenes de trabajo
//                ‚îú‚îÄ‚îÄ repuestos/     - Inventario
//                ‚îú‚îÄ‚îÄ facturas/      - Facturas generadas
//                ‚îú‚îÄ‚îÄ pagos/         - Registro de pagos
//                ‚îî‚îÄ‚îÄ productos/     - Cat√°logo de productos
//
//    Funcionalidades cubiertas:
//    ‚úÖ Crear/editar/eliminar clientes
//    ‚úÖ Crear/editar √≥rdenes de reparaci√≥n
//    ‚úÖ Cambiar estados de √≥rdenes (pendiente, proceso, completado)
//    ‚úÖ Registrar pagos y actualizar saldos
//    ‚úÖ Agregar/editar/eliminar repuestos del inventario
//    ‚úÖ Controlar stock de repuestos
//    ‚úÖ Generar facturas personalizadas con logo
//    ‚úÖ Generar reportes (ventas, inventario, clientes)
//    ‚úÖ Buscar clientes y √≥rdenes
//    ‚úÖ Ver historial completo de clientes
//
// ====================================================================
// VERIFICACI√ìN POST-APLICACI√ìN
// ====================================================================
//
// Despu√©s de publicar las reglas, verifica que funcionan:
//
// 1. Abre tu aplicaci√≥n: https://tu-taller.netlify.app
// 2. Abre la consola del navegador (F12)
// 3. Ve a "Configuraci√≥n" y guarda tus datos
// 4. Deber√≠as ver en la consola:
//    ‚úÖ Configuraci√≥n guardada exitosamente en Firebase
//    ‚úÖ Configuraci√≥n guardada y sincronizada en la nube
//
// 5. Si ves errores "permission-denied":
//    - Verifica que pegaste las reglas correctamente
//    - Aseg√∫rate de hacer clic en "Publicar"
//    - Refresca la p√°gina (Ctrl+F5 o Cmd+Shift+R)
//    - Cierra sesi√≥n y vuelve a iniciar
//
// 6. Prueba en otro equipo:
//    - Inicia sesi√≥n con la misma cuenta
//    - Ve a "Configuraci√≥n"
//    - Deber√≠as ver tus datos autom√°ticamente
//
// ====================================================================
// SEGURIDAD
// ====================================================================
//
// ‚ö†Ô∏è IMPORTANTE: Estas reglas son PERMISIVAS (allow: if true)
//    para permitir el funcionamiento completo del sistema.
//
// En producci√≥n considera restringir seg√∫n tu caso:
// - allow read, write: if request.auth != null;
//   (Solo usuarios autenticados)
//
// - allow read, write: if request.auth.uid == userId;
//   (Solo el due√±o de los datos)
//
// Para este taller, las reglas actuales permiten:
// ‚úÖ Usuarios sin cuenta de Google (usuarios normales)
// ‚úÖ Usuarios con cuenta de Google (autenticados)
// ‚úÖ Sincronizaci√≥n entre dispositivos
// ‚úÖ Todas las funcionalidades del sistema
//
// ====================================================================
