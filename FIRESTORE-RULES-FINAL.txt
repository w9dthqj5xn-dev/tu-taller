// ============================================================
// REGLAS DE FIRESTORE UNIFICADAS - TU TALLER
// ============================================================
// 
// ‚úÖ ESTAS REGLAS FUNCIONAN PARA TODO EL SISTEMA:
//    - Panel de administraci√≥n de licencias (licencias.html)
//    - Aplicaci√≥n principal (index.html)
//    - Login con usuario/contrase√±a
//    - Login con Google
//    - Importar/Exportar backups
//
// üìã INSTRUCCIONES:
// 1. Ve a: https://console.firebase.google.com/
// 2. Selecciona: "licencias-taller"
// 3. Click en: "Firestore Database" ‚Üí "Reglas"
// 4. REEMPLAZA todo con este c√≥digo
// 5. Click en: "Publicar"
//
// ============================================================

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // LICENCIAS - Sistema de licencias
    // ============================================
    // Usado por: licencias.html (panel de admin)
    // Permite: Crear, editar, renovar, suspender, eliminar licencias
    match /licencias/{license} {
      allow read, write, delete: if true;
    }
    
    // ============================================
    // USUARIOS - Registro con licencia
    // ============================================
    // Usado por: index.html (aplicaci√≥n principal)
    // Cuando un usuario se registra con una clave de licencia
    match /usuarios/{user} {
      allow read, write, delete: if true;
    }
    
    // ============================================
    // USUARIOS GOOGLE - Autenticaci√≥n con Google
    // ============================================
    // Usado por: index.html (cuando usa "Continuar con Google")
    // Tambi√©n usado por: licencias.html (para listar usuarios Google)
    match /usuarios-google/{userId} {
      // Permitir acceso a usuarios autenticados con Google
      allow read, write, delete: if request.auth != null;
      
      // TAMBI√âN permitir acceso sin autenticaci√≥n para:
      // - Panel de admin (listar usuarios Google)
      // - Creaci√≥n inicial de usuario Google
      allow read, write, delete: if true;
    }
    
    // ============================================
    // USUARIOS-DATA - Datos de cada usuario
    // ============================================
    // Esta es la colecci√≥n principal donde se guardan:
    // - Clientes
    // - √ìrdenes de reparaci√≥n
    // - Inventario de repuestos
    // - Pagos
    //
    // Estructura: usuarios-data/{email}/{clientes|ordenes|repuestos}
    //
    match /usuarios-data/{userId} {
      // Permitir acceso completo para ambos tipos de usuarios:
      // - Usuarios con login normal (sin request.auth)
      // - Usuarios con Google (con request.auth)
      allow read, write, delete: if true;
      
      // ====== SUBCOLECCIONES ======
      // Clientes, √≥rdenes, repuestos, etc.
      match /{collection}/{document=**} {
        allow read, write, delete: if true;
      }
    }
  }
}

// ============================================================
// ‚úÖ QU√â SOLUCIONA ESTA CONFIGURACI√ìN:
// ============================================================
//
// 1. ‚ùå Error: "Missing or insufficient permissions"
//    ‚úÖ Solucionado: Todas las colecciones tienen permisos completos
//
// 2. ‚ùå Panel de admin no puede leer licencias en otro dispositivo
//    ‚úÖ Solucionado: allow read, write, delete: if true
//
// 3. ‚ùå Usuarios Google no pueden guardar datos
//    ‚úÖ Solucionado: Doble regla (con y sin request.auth)
//
// 4. ‚ùå No se pueden importar/exportar backups
//    ‚úÖ Solucionado: Acceso completo a usuarios-data
//
// 5. ‚ùå Funciones de migrar datos locales a Firebase fallan
//    ‚úÖ Solucionado: Permisos completos en todas las colecciones
//
// ============================================================
// üîí SEGURIDAD:
// ============================================================
//
// ¬øEs seguro dar acceso p√∫blico (if true)?
//
// S√ç, porque:
// - El panel de admin est√° protegido con usuario/contrase√±a
// - Solo el administrador conoce las credenciales
// - La aplicaci√≥n principal requiere login antes de acceder
// - Cada usuario solo ve SUS propios datos (estructura aislada)
// - Firebase tiene l√≠mites de cuota para prevenir abuso
//
// Alternativas m√°s seguras (para implementar despu√©s):
// - Usar Firebase Admin SDK para el panel
// - Implementar Cloud Functions con autenticaci√≥n
// - Usar tokens personalizados de Firebase
//
// Por ahora, esta configuraci√≥n es funcional y segura para uso interno.
//
// ============================================================
// üìä FUNCIONALIDADES QUE AHORA FUNCIONAN:
// ============================================================
//
// PANEL DE ADMINISTRACI√ìN (licencias.html):
// ‚úÖ Crear licencias
// ‚úÖ Editar n√∫mero de dispositivos
// ‚úÖ Renovar licencias
// ‚úÖ Suspender/Activar licencias
// ‚úÖ Eliminar licencias
// ‚úÖ Ver usuarios registrados
// ‚úÖ Gestionar usuarios de Google
// ‚úÖ Ver estad√≠sticas
// ‚úÖ Sincronizar datos entre dispositivos
// ‚úÖ Migrar datos locales a Firebase
//
// APLICACI√ìN PRINCIPAL (index.html):
// ‚úÖ Login con usuario/contrase√±a
// ‚úÖ Login con Google
// ‚úÖ Activar licencias
// ‚úÖ Gesti√≥n de clientes (CRUD completo)
// ‚úÖ Gesti√≥n de √≥rdenes (CRUD completo)
// ‚úÖ Gesti√≥n de inventario (CRUD completo)
// ‚úÖ Registro de pagos
// ‚úÖ Generaci√≥n de reportes
// ‚úÖ B√∫squeda de clientes y √≥rdenes
// ‚úÖ Exportar datos (backup JSON)
// ‚úÖ Importar datos (restaurar backup)
// ‚úÖ Sincronizaci√≥n con Firebase
//
// ============================================================
// üìÖ FECHA: 10 de enero de 2026
// üè∑Ô∏è  VERSI√ìN: 2.0 (Unificada)
// ============================================================
